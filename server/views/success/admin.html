<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1>Admin Page</h1>
            <p>Welcome admin !</p>
        </div>
    </div>
    <div class="row">
        <div class="col-12">
            <div class="card mb-3">
                <div class="card-header">
                    <i class="fa fa-user-circle"></i> Users
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered" id="adminPageUsersDataTable" width="100%" cellspacing="0">
                            <thead>
                            <tr>
                                <th>First Name</th>
                                <th>Last Name</th>
                                <th>Login</th>
                                <th>Email</th>
                                <th>Active</th>
                            </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer small text-muted">List of the users of Scipio</div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-12">
            <div class="card mb-3">
                <div class="card-header">
                    <i class="fa fa-user-circle"></i> Permissions
                </div>
                <div class="card-body">

                </div>
                <div class="card-footer small text-muted">Manage the access of the users of Scipio</div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card mb-3">
                <div class="card-header">
                    <i class="fa fa-user-circle"></i> Create a new User
                </div>
                <div class="card-body">
                    <form name="adminPageCreateUserForm">
                        <div class="form-group">
                            <label for="adminPageCreateUserFormLogin">The base login of the user</label>
                            <input class="form-control" type="text" id="adminPageCreateUserFormLogin" name="login">
                        </div>
                        <div class="form-group">
                            <button class="btn btn-primary" id="adminPageCreateUserFormButton" type="button">Get Code</button>
                        </div>
                    </form>
                    <form>
                        <div class="form-group">
                            <label for="adminPageCreateUserFormCode">Generated code</label>
                            <input class="form-control" type="text" id="adminPageCreateUserFormCode">
                        </div>
                    </form>
                </div>
                <div class="card-footer small text-muted">Create a new user with a set login and create an url</div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card mb-3">
                <div class="card-header">
                    <i class="fa fa-user-circle"></i> Empty
                </div>
                <div class="card-body">
                </div>
                <div class="card-footer small text-muted">Empty card for dev purposes</div>
            </div>
        </div>
    </div>

    <script>
        const deactivateUser = (login) => {
            if(confirm("Are you sure you want to deactivate the account of " + login)){
                $.ajax({
                    url:'/api/admin/deactivate-user',
                    data: {
                        login: login
                    },
                    type: 'POST',
                    noprint: true
                })
                    .then(ret => {
                        toastS("Account was deactivated");
                        loadAdminPageUsersDataTable();
                    })
            }
        };

        const resendConfirmationEmail = (login) => {
            $.ajax({
                url:'/api/admin/resend-mail',
                data:{
                    login:login
                },
                type: 'POST',
                noprint: true
            })
                .then(ret => {
                    toastS("Mail sent");
                })
        };

        const loadAdminPage = () => {
            loadAdminPageUsersDataTable();
        };

        const adminPageDatatable = $('#adminPageUsersDataTable').DataTable();

        const loadAdminPageUsersDataTable = () => {
            adminPageDatatable.clear();
            $.ajax({
                url: '/api/user',
                type: 'GET',
                noprint: true
            })
                .then((ret) => {
                    ret.forEach(user => {
                        adminPageDatatable.row.add([
                            user.first_name,
                            user.last_name,
                            user.login,
                            user.email,
                            user.active ?
                                '<button id="adminPageUserDeactivate_'+ user.login +'" class="btn btn-primary">Desactivate account</button>' :
                                '<button id="adminPageUserResendMail_'+ user.login +'" class="btn btn-primary">Resend confirmation mail</button>'
                        ]).draw();

                        $('#adminPageUserDeactivate_' + user.login).click((event) => {
                            deactivateUser(user.login);
                        });

                        $('#adminPageUserResendMail_' + user.login).click((event) => {
                           resendConfirmationEmail(user.login);
                        });

                    });
                })
        };

        $(() => {
            $('#adminPageCreateUserFormButton').click((event) => {
                let data = getFormValuesFromClick(event);
                if (!data || data === {}) return false;
                console.log(data);
                $.ajax({
                    url:'/api/admin/create-code',
                    type: 'GET',
                    data: data,
                    noprint:true
                })
                    .then(ret => {
                        $('#adminPageCreateUserFormCode').val(ret);
                    });
            });

            loadAdminPage();

        })
    </script>
</div>